generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

enum FlightStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum DocumentType {
  GENERAL_DECLARATION
  PASSENGER_MANIFEST
  CREW_LIST
  BAGGAGE_REPORT
}

enum DocumentStatus {
  PENDING
  GENERATED
  SENT
  ARCHIVED
}

enum QRPassType {
  PASSENGER
  CREW
  HANDLER
  AUTHORITY
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ACCESS
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  users       User[]
}

model User {
  id             String      @id @default(uuid())
  email          String      @unique
  passwordHash   String
  roleId         Int
  role           Role        @relation(fields: [roleId], references: [id])
  status         UserStatus  @default(ACTIVE)
  lastLoginAt    DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  auditLogs      AuditLog[]
  documents      Document[]  @relation("DocumentGeneratedBy")
}

model Airport {
  id        String   @id
  iataCode  String?  @unique
  icaoCode  String   @unique
  name      String
  city      String
  country   String
  timezone  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  departures Flight[] @relation("DepartureAirport")
  arrivals   Flight[] @relation("ArrivalAirport")
}

model Flight {
  id                String           @id @default(uuid())
  uid               String           @unique
  operatorName      String
  aircraftType      String
  aircraftRegistration String
  mtow              Int?
  purpose           String?
  departureAirportId String
  departureAirport   Airport         @relation("DepartureAirport", fields: [departureAirportId], references: [id])
  arrivalAirportId   String
  arrivalAirport     Airport         @relation("ArrivalAirport", fields: [arrivalAirportId], references: [id])
  scheduledDeparture DateTime
  actualDeparture    DateTime?
  scheduledArrival   DateTime
  actualArrival      DateTime?
  status             FlightStatus    @default(PLANNED)
  turnaroundStatus   String?
  captainName        String?
  firstOfficerName   String?
  passengerCount     Int             @default(0)
  crewCount          Int             @default(0)
  version            Int             @default(1)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  passengers         Passenger[]
  crew               CrewMember[]
  baggageItems       BaggageItem[]
  documents          Document[]
  qrPasses           QRPass[]
  authorityEvents    AuthorityNotification[] @relation("FlightAuthorityEvents")
}

model Passenger {
  id              String    @id @default(uuid())
  flightId        String
  flight          Flight    @relation(fields: [flightId], references: [id])
  uid             String    @default(uuid()) @unique
  fullName        String
  gender          String?
  dateOfBirth     DateTime?
  nationality     String?
  passportNumber  String?
  passportCountry String?
  passportExpiry  DateTime?
  visaNumber      String?
  status          String?   // arrived, ready_for_boarding, onboard
  seatNumber      String?
  baggageCount    Int       @default(0)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  baggageItems    BaggageItem[]
  qrPasses        QRPass[]
}

model CrewMember {
  id              String    @id @default(uuid())
  flightId        String
  flight          Flight    @relation(fields: [flightId], references: [id])
  uid             String    @default(uuid()) @unique
  fullName        String
  rank            String?
  nationality     String?
  licenceNumber   String?
  licenceExpiry   DateTime?
  dutyType        String?   // operating, deadheading
  status          String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  qrPasses        QRPass[]
}

model BaggageItem {
  id             String    @id @default(uuid())
  flightId       String
  flight         Flight    @relation(fields: [flightId], references: [id])
  passengerId    String?
  passenger      Passenger? @relation(fields: [passengerId], references: [id])
  tagCode        String    @unique
  weightKg       Float?
  pieces         Int       @default(1)
  status         String    @default("created")
  lastScannedAt  DateTime?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model QRPass {
  id             String      @id @default(uuid())
  token          String      @unique
  type           QRPassType
  flightId       String
  flight         Flight      @relation(fields: [flightId], references: [id])
  passengerId    String?
  passenger      Passenger?  @relation(fields: [passengerId], references: [id])
  crewMemberId   String?
  crewMember     CrewMember? @relation(fields: [crewMemberId], references: [id])
  accessLevel    String
  payloadHash    String
  generatedById  String?
  generatedBy    User?       @relation(fields: [generatedById], references: [id])
  generatedAt    DateTime    @default(now())
  sentAt         DateTime?
  expiresAt      DateTime?
  status         String      @default("active")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([flightId])
  @@unique([passengerId, type])
  @@unique([crewMemberId, type])
}

model Document {
  id             String         @id @default(uuid())
  flightId       String
  flight         Flight         @relation(fields: [flightId], references: [id])
  type           DocumentType
  status         DocumentStatus @default(PENDING)
  storageKey     String
  checksum       String?
  metadata       Json?
  templateId     String?
  template       DocumentTemplate? @relation(fields: [templateId], references: [id])
  generatedById  String?
  generatedBy    User?          @relation("DocumentGeneratedBy", fields: [generatedById], references: [id])
  generatedAt    DateTime?
  sentToAuthority Boolean       @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  notifications  AuthorityNotification[] @relation("DocumentNotifications")
}

model DocumentTemplate {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        DocumentType
  version     String       @default("v1")
  storageKey  String
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  documents   Document[]

  @@unique([type, version])
}

model AuthorityNotification {
  id           String    @id @default(uuid())
  flightId     String
  flight       Flight    @relation("FlightAuthorityEvents", fields: [flightId], references: [id])
  documentId   String?
  document     Document? @relation("DocumentNotifications", fields: [documentId], references: [id])
  channel      String
  recipient    String
  status       String    @default("pending")
  responseCode String?
  responseBody String?
  attemptedAt  DateTime  @default(now())
  createdAt    DateTime  @default(now())
}

model AuditLog {
  id            String      @id @default(uuid())
  actorId       String?
  actor         User?       @relation(fields: [actorId], references: [id])
  action        AuditAction
  resourceType  String
  resourceId    String
  metadata      Json?
  createdAt     DateTime    @default(now())
}

